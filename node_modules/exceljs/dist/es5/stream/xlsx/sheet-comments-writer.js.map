{"version":3,"sources":["../../../../lib/stream/xlsx/sheet-comments-writer.js"],"names":["XmlStream","require","RelType","colCache","CommentXform","VmlNoteXform","SheetCommentsWriter","module","exports","worksheet","sheetRelsWriter","options","id","count","_worksheet","_workbook","workbook","_sheetRelsWriter","prototype","commentsStream","_commentsStream","_openStream","vmlStream","_vmlStream","_addRelationships","commentRel","Type","Comments","Target","addRelationship","vmlDrawingRel","VmlDrawing","vmlRelId","_addCommentRefs","commentRefs","push","commentName","vmlDrawing","_writeOpen","write","_writeComment","comment","index","commentXform","commentsXmlStream","render","xml","vmlNoteXform","vmlXmlStream","_writeClose","addComments","comments","length","startedData","forEach","item","refAddress","decodeAddress","ref","commit","end"],"mappings":"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","sourcesContent":["'use strict';\n\nconst XmlStream = require('../../utils/xml-stream');\nconst RelType = require('../../xlsx/rel-type');\nconst colCache = require('../../utils/col-cache');\nconst CommentXform = require('../../xlsx/xform/comment/comment-xform');\nconst VmlNoteXform = require('../../xlsx/xform/comment/vml-note-xform');\n\nconst SheetCommentsWriter = (module.exports = function(worksheet, sheetRelsWriter, options) {\n  // in a workbook, each sheet will have a number\n  this.id = options.id;\n  this.count = 0;\n  this._worksheet = worksheet;\n  this._workbook = options.workbook;\n  this._sheetRelsWriter = sheetRelsWriter;\n});\n\nSheetCommentsWriter.prototype = {\n  get commentsStream() {\n    if (!this._commentsStream) {\n      // eslint-disable-next-line no-underscore-dangle\n      this._commentsStream = this._workbook._openStream(`/xl/comments${this.id}.xml`);\n    }\n    return this._commentsStream;\n  },\n  get vmlStream() {\n    if (!this._vmlStream) {\n      // eslint-disable-next-line no-underscore-dangle\n      this._vmlStream = this._workbook._openStream(`xl/drawings/vmlDrawing${this.id}.vml`);\n    }\n    return this._vmlStream;\n  },\n  \n  _addRelationships(){\n    const commentRel = {\n      Type: RelType.Comments,\n      Target: `../comments${this.id}.xml`,\n    };\n    this._sheetRelsWriter.addRelationship(commentRel);\n\n    const vmlDrawingRel = {\n      Type: RelType.VmlDrawing,\n      Target: `../drawings/vmlDrawing${this.id}.vml`,\n    };\n    this.vmlRelId = this._sheetRelsWriter.addRelationship(vmlDrawingRel);\n  },\n\n  _addCommentRefs(){\n    this._workbook.commentRefs.push({\n      commentName: `comments${this.id}`,\n      vmlDrawing: `vmlDrawing${this.id}`,\n    });\n  },\n\n  _writeOpen() {\n    this.commentsStream.write(\n      '<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?>' +\n      '<comments xmlns=\"http://schemas.openxmlformats.org/spreadsheetml/2006/main\">' +\n      '<authors><author>Author</author></authors>' +\n      '<commentList>'\n    );\n    this.vmlStream.write(\n      '<?xml version=\"1.0\" encoding=\"UTF-8\"?>' +\n      '<xml xmlns:o=\"urn:schemas-microsoft-com:office:office\" xmlns:v=\"urn:schemas-microsoft-com:vml\" xmlns:x=\"urn:schemas-microsoft-com:office:excel\">' +\n        '<o:shapelayout v:ext=\"edit\">' +\n            '<o:idmap v:ext=\"edit\" data=\"1\" />' +\n        '</o:shapelayout>' +\n        '<v:shapetype id=\"_x0000_t202\" coordsize=\"21600,21600\" o:spt=\"202\" path=\"m,l,21600r21600,l21600,xe\">' +\n            '<v:stroke joinstyle=\"miter\" />' +\n            '<v:path gradientshapeok=\"t\" o:connecttype=\"rect\" />' +\n        '</v:shapetype>'\n    );\n  },\n\n  _writeComment(comment, index) {\n    const commentXform = new CommentXform();\n    const commentsXmlStream = new XmlStream();\n    commentXform.render(commentsXmlStream, comment);\n    this.commentsStream.write(commentsXmlStream.xml);\n\n    const vmlNoteXform = new VmlNoteXform();\n    const vmlXmlStream = new XmlStream();\n    vmlNoteXform.render(vmlXmlStream, comment, index);\n    this.vmlStream.write(vmlXmlStream.xml);\n  },\n\n  _writeClose() {\n    this.commentsStream.write('</commentList></comments>');\n    this.vmlStream.write('</xml>');\n  },\n\n  addComments(comments){\n    if(comments && comments.length){\n      if(!this.startedData){\n        this._worksheet.comments = [];\n        this._writeOpen();\n        this._addRelationships();\n        this._addCommentRefs();\n        this.startedData = true;\n      }\n      \n      comments.forEach(item => {\n        item.refAddress = colCache.decodeAddress(item.ref);\n      });\n      \n      comments.forEach((comment)=>{\n        this._writeComment(comment, this.count);\n        this.count += 1;\n      });\n    }\n  },\n\n  commit() {\n    if (this.count) {\n      this._writeClose();\n      this.commentsStream.end();\n      this.vmlStream.end();\n    }\n  },\n  \n};\n"],"file":"sheet-comments-writer.js"}